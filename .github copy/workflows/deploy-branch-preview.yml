name: Deploy Branch Preview (API â†’ Web â†’ Test)

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  deployments: write
  checks: write

jobs:
  deploy-api:
    uses: ./.github/workflows/deploy-api-branch.yml
    secrets: inherit
    with:
      branch_name: ${{ github.head_ref }}
      pr_number: ${{ github.event.number }}

  test-api:
    needs: deploy-api
    uses: ./.github/workflows/test-api-branch.yml
    secrets: inherit
    with:
      api_deployment_url: ${{ needs.deploy-api.outputs.deployment_url }}
      branch_name: ${{ github.head_ref }}
      pr_number: ${{ github.event.number }}

  deploy-web:
    needs: [deploy-api, test-api]
    if: needs.test-api.result == 'success'
    uses: ./.github/workflows/deploy-web-branch.yml
    secrets: inherit
    with:
      branch_name: ${{ github.head_ref }}
      pr_number: ${{ github.event.number }}
      api_url: ${{ needs.deploy-api.outputs.deployment_url }}

  test-integration:
    needs: [deploy-api, test-api, deploy-web]
    uses: ./.github/workflows/test-branch-integration.yml
    secrets: inherit
    with:
      web_url: ${{ needs.deploy-web.outputs.deployment_url }}
      api_url: ${{ needs.deploy-api.outputs.deployment_url }}

  test-e2e:
    needs: [deploy-api, test-api, deploy-web, test-integration]
    if: needs.test-integration.result == 'success'
    uses: ./.github/workflows/test-branch-e2e.yml
    secrets: inherit
    with:
      web_url: ${{ needs.deploy-web.outputs.deployment_url }}
      api_url: ${{ needs.deploy-api.outputs.deployment_url }}
      branch_name: ${{ github.head_ref }}
      pr_number: ${{ github.event.number }}

  update-pr:
    needs: [deploy-api, test-api, deploy-web, test-integration, test-e2e]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ’¬ Update PR with Deployment Status
        uses: actions/github-script@v7
        with:
          script: |
            const webUrl = '${{ needs.deploy-web.outputs.deployment_url }}';
            const apiUrl = '${{ needs.deploy-api.outputs.deployment_url }}';
            const apiTestStatus = '${{ needs.test-api.result }}';
            const integrationStatus = '${{ needs.test-integration.result }}';
            const e2eStatus = '${{ needs.test-e2e.result }}';
            const apiStatus = '${{ needs.deploy-api.result }}';
            const webStatus = '${{ needs.deploy-web.result }}';
            
            // Determine overall test status
            const allTestsPassed = apiTestStatus === 'success' && integrationStatus === 'success' && e2eStatus === 'success';
            const statusEmoji = allTestsPassed ? 'âœ…' : 'âš ï¸';
            const statusText = allTestsPassed ? 'All tests passed!' : 'Some tests failed';
            
            // Handle deployment failures
            let deploymentSection = '';
            if (apiStatus === 'success' && webStatus === 'success') {
              deploymentSection = `## ğŸš€ DEPLOYMENT BRANCH

            ### ğŸŒ Web App
            **Live Preview:** [${webUrl}](${webUrl})

            ### âš¡ API Service  
            **API Endpoint:** [${apiUrl}](${apiUrl})

            ### ğŸ§ª Quick Test Links
            - [ğŸ“± Web App](${webUrl}) - Test the user interface
            - [â¤ï¸ API Health](${apiUrl}/health) - Verify API status
            - [ğŸ”— Click here to test!](${webUrl})

            ### ğŸ§ª Test Results
            - **API Tests**: ${apiTestStatus === 'success' ? 'âœ… Passed' : apiTestStatus === 'skipped' ? 'â­ï¸ Skipped' : 'âŒ Failed'}
            - **Integration Tests**: ${integrationStatus === 'success' ? 'âœ… Passed' : integrationStatus === 'skipped' ? 'â­ï¸ Skipped' : 'âŒ Failed'}
            - **E2E Tests**: ${e2eStatus === 'success' ? 'âœ… Passed' : e2eStatus === 'skipped' ? 'â­ï¸ Skipped' : 'âŒ Failed'}
            
            ${statusEmoji} ${statusText}`;
            } else {
              deploymentSection = `## âŒ FAILED

            ### Deployment Status
            - **API**: ${apiStatus === 'success' ? 'âœ…' : 'âŒ'} ${apiStatus === 'success' ? apiUrl : 'Deployment failed'}
            - **Web**: ${webStatus === 'success' ? 'âœ…' : 'âŒ'} ${webStatus === 'success' ? webUrl : 'Deployment failed'}
            
            ${apiStatus !== 'success' ? `**API Error:** ${apiUrl || 'API deployment failed - check logs'}` : ''}
            ${webStatus !== 'success' ? `**Web Error:** ${webUrl || 'Web deployment failed - check logs'}` : ''}`;
            }

            const commentBody = `${deploymentSection}

            ---
            *ğŸ”„ Last updated: ${new Date().toLocaleString()} UTC*
            
            <!-- BRANCH_DEPLOYMENT_COMMENT -->`;

            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const existingComment = comments.data.find(comment => 
              comment.body.includes('<!-- BRANCH_DEPLOYMENT_COMMENT -->')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                comment_id: existingComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: commentBody
              });
            } 