name: Test Main Integration

on:
  workflow_call:
    inputs:
      web_url:
        required: true
        type: string
      api_url:
        required: true
        type: string

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ›’ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ğŸ” Environment Validation
        run: |
          echo "ğŸ§ª Main Production Web App: ${{ inputs.web_url }}"
          echo "ğŸ§ª Main Production API Service: ${{ inputs.api_url }}"
          
          if [[ ! "${{ inputs.web_url }}" =~ ^https?:// ]] || [[ ! "${{ inputs.api_url }}" =~ ^https?:// ]]; then
            echo "âŒ Invalid URL format"
            exit 1
          fi
      
      - name: ğŸ¥ API Health Check
        run: |
          echo "ğŸ” Testing main production API health endpoint..."
          
          for i in {1..3}; do
            echo "Health check attempt $i/3..."
            
            if curl -f "${{ inputs.api_url }}/health" -m 15; then
              echo "âœ… API health check passed"
              break
            fi
            
            if [ $i -eq 3 ]; then
              echo "âŒ API health check failed after 3 attempts"
              exit 1
            fi
            
            echo "â³ Waiting 10 seconds..."
            sleep 10
          done
      
      - name: ğŸ“± Web App Accessibility Test
        run: |
          echo "ğŸ” Testing main production web app accessibility..."
          
          for i in {1..3}; do
            echo "Web accessibility test attempt $i/3..."
            
            if curl -f "${{ inputs.web_url }}" -m 15 > /dev/null 2>&1; then
              echo "âœ… Web app is accessible"
              break
            fi
            
            if [ $i -eq 3 ]; then
              echo "âŒ Web app accessibility test failed after 3 attempts"
              exit 1
            fi
            
            echo "â³ Waiting 10 seconds..."
            sleep 10
          done
      
      - name: ğŸ”— API Integration Test
        run: |
          echo "ğŸ” Testing API integration with main production deployment..."
          
          # Test API endpoints
          echo "ğŸ“„ Testing pull requests API endpoint..."
          if curl -f "${{ inputs.api_url }}/api/github/pull-requests/test" -m 15; then
            echo "âœ… Pull requests API endpoint is working"
          else
            echo "âŒ Pull requests API endpoint failed"
            exit 1
          fi
          
          echo "âœ… API integration tests passed!"
      
      - name: ğŸŒ CORS Configuration Test
        run: |
          echo "ğŸ” Testing CORS configuration between web app and API..."
          
          # Test CORS preflight request
          CORS_RESPONSE=$(curl -s -X OPTIONS "${{ inputs.api_url }}/health" \
            -H "Origin: ${{ inputs.web_url }}" \
            -H "Access-Control-Request-Method: GET" \
            -H "Access-Control-Request-Headers: Content-Type" \
            -w "%{http_code}" -o /dev/null)
          
          if [ "$CORS_RESPONSE" = "200" ]; then
            echo "âœ… CORS configuration is working correctly"
          else
            echo "âš ï¸ CORS preflight returned status: $CORS_RESPONSE"
            echo "ğŸ” This may indicate CORS issues between web app and API"
          fi
      
      - name: ğŸ“¦ Setup Node.js for Integration Tests
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: integration/package-lock.json
      
      - name: ğŸ“¥ Install Integration Dependencies
        run: |
          cd integration
          npm ci
      
      - name: ğŸ”§ Build Observability Package
        run: |
          cd packages/observability
          npm ci
          npm run build
      
      - name: ğŸ§ª Run Integration Tests
        run: |
          echo "ğŸš€ Running main production integration tests..."
          cd integration
          npm run test:main
        env:
          WEB_URL: ${{ inputs.web_url }}
          API_URL: ${{ inputs.api_url }}
        continue-on-error: true
      
      - name: ğŸ“Š Integration Test Summary
        run: |
          echo "ğŸ¯ Main Production Integration Testing Complete!"
          echo "ğŸ“ Web URL: ${{ inputs.web_url }}"
          echo "ğŸ“ API URL: ${{ inputs.api_url }}"
          echo "âœ… Environment validation passed"
          echo "âœ… API health checks passed"
          echo "âœ… Web app accessibility passed"
          echo "âœ… API integration tests passed"
          echo "ğŸŒ CORS configuration verified"
          echo "ğŸ“‹ Integration tests completed" 