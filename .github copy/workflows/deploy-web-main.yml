name: Deploy Web to Firebase (Main)

on:
  workflow_call:
    inputs:
      api_url:
        required: true
        type: string
    outputs:
      deployment_url:
        description: "Web deployment URL"
        value: ${{ jobs.deploy.outputs.deployment_url }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    outputs:
      deployment_url: ${{ steps.set_url.outputs.deployment_url }}
    
    steps:
      - name: ğŸ›’ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: apps/web/package-lock.json
      
      - name: ğŸ“¥ Install Web Dependencies  
        run: |
          cd apps/web
          echo "ğŸ” Checking package-lock.json sync..."
          
          # Try npm ci first (preferred for CI)
          if npm ci; then
            echo "âœ… Dependencies installed with npm ci"
          else
            echo "âš ï¸ npm ci failed - lock file may be out of sync"
            echo "ğŸ”§ Attempting to fix with npm install..."
            
            # Remove node_modules and package-lock.json to start fresh
            rm -rf node_modules package-lock.json
            
            # Install dependencies and regenerate lock file
            npm install
            
            echo "âœ… Dependencies installed with npm install (lock file regenerated)"
          fi
      
      - name: ğŸ”§ Configure API Integration
        run: |
          echo "ğŸ”— API URL: ${{ inputs.api_url }}"
          if [[ ! "${{ inputs.api_url }}" =~ ^https?:// ]]; then
            echo "âŒ Invalid API URL format"
            exit 1
          fi
          
          cd apps/web
          
          # Create environment file for build (legacy approach)
          echo "REACT_APP_API_BASE_URL=${{ inputs.api_url }}" > .env.production
          echo "DOCUSAURUS_API_BASE_URL=${{ inputs.api_url }}" >> .env.production
          
          # Create dynamic runtime config (new simple approach)
          echo "window.APP_CONFIG = { apiBaseUrl: '${{ inputs.api_url }}' };" > static/config.js
          echo "ğŸ“ Generated config.js with API URL: ${{ inputs.api_url }}"
          
          echo "âœ… API integration configured"
      
      - name: ğŸ§ª Run Web Tests
        run: |
          cd apps/web
          npm test 2>/dev/null || echo "âš ï¸ Tests not configured or failed"
      
      - name: ğŸ—ï¸ Build Web App
        run: |
          cd apps/web
          npm run build
        env:
          REACT_APP_API_BASE_URL: ${{ inputs.api_url }}
          DOCUSAURUS_API_BASE_URL: ${{ inputs.api_url }}
      
      - name: ğŸ” Deploy to Firebase (Main)
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_LAURIECREAN_FREE_38256 }}
          projectId: lauriecrean-free-38256
          channelId: live
          entryPoint: apps/web
        id: deploy
      
      - name: ğŸ” Debug Firebase Deploy Outputs
        run: |
          echo "ğŸ” Firebase Deploy Action Outputs:"
          echo "details_url: '${{ steps.deploy.outputs.details_url }}'"
          echo "urls: '${{ steps.deploy.outputs.urls }}'"
          echo "expire_time: '${{ steps.deploy.outputs.expire_time }}'"
      
      - name: ğŸ”— Set Deployment URL
        id: set_url
        run: |
          # Try Firebase action outputs first
          DETAILS_URL="${{ steps.deploy.outputs.details_url }}"
          URLS_OUTPUT="${{ steps.deploy.outputs.urls }}"
          
          echo "ğŸ” Checking Firebase action outputs..."
          echo "details_url: '$DETAILS_URL'"
          echo "urls: '$URLS_OUTPUT'"
          
          # Use Firebase action outputs if available
          if [[ -n "$DETAILS_URL" && "$DETAILS_URL" != "null" ]]; then
            DEPLOYMENT_URL="$DETAILS_URL"
            echo "âœ… Using details_url from Firebase action: $DEPLOYMENT_URL"
          elif [[ -n "$URLS_OUTPUT" && "$URLS_OUTPUT" != "null" ]]; then
            # Extract first URL from urls output if it contains multiple URLs
            DEPLOYMENT_URL=$(echo "$URLS_OUTPUT" | head -n1 | sed 's/,.*$//')
            echo "âœ… Using first URL from Firebase action: $DEPLOYMENT_URL"
          else
            # Fallback to predictable Firebase main URL
            DEPLOYMENT_URL="https://lauriecrean-free-38256.web.app"
            echo "âš ï¸ Firebase action outputs empty, using fallback URL: $DEPLOYMENT_URL"
          fi
          
          echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
      
      - name: âœ… Validate Web Deployment
        run: |
          WEB_URL="${{ steps.set_url.outputs.deployment_url }}"
          echo "ğŸ” Testing main production web app at: $WEB_URL"
          
          # Test if web app is accessible
          for i in {1..3}; do
            echo "ğŸ“± Web accessibility test $i/3..."
            if curl -f "$WEB_URL" -m 15 >/dev/null 2>&1; then
              echo "âœ… Web app is accessible!"
              break
            fi
            
            if [ $i -eq 3 ]; then
              echo "âŒ Web accessibility test failed"
              exit 1
            fi
            
            echo "â³ Waiting 10 seconds before retry..."
            sleep 10
          done
      
      - name: ğŸ“Š Deployment Summary
        run: |
          echo "ğŸŒŸ Main Production Web Deployment Complete!"
          echo "ğŸ“ URL: ${{ steps.set_url.outputs.deployment_url }}"
          echo "ğŸ”Œ API Connected: ${{ inputs.api_url }}"
          echo "ğŸš€ Production deployment ready!"
          echo "âœ… Ready for integration testing" 