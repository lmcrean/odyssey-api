name: Deploy API to Google Cloud Run (Main)

on:
  workflow_call:
    outputs:
      deployment_url:
        description: "API deployment URL"
        value: ${{ jobs.deploy.outputs.deployment_url }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    outputs:
      deployment_url: ${{ steps.deploy.outputs.deployment_url }}
    
    steps:
      - name: ğŸ›’ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
      
      - name: ğŸ“¥ Restore API Dependencies
        run: |
          cd apps/api
          dotnet restore
      
      - name: ğŸ”§ Build API
        run: |
          cd apps/api
          dotnet build --configuration Release --no-restore
      
      - name: ğŸ§ª Run API Tests
        run: |
          cd apps/api
          dotnet test --configuration Release --no-build --verbosity normal 2>/dev/null || echo "âš ï¸ Tests not configured or failed"
      
      - name: ğŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: ğŸ› ï¸ Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
      
      - name: ğŸ” Validate GCP Authentication & Permissions
        run: |
          echo "=== ğŸ” VALIDATING GCP AUTHENTICATION ==="
          
          # Test basic authentication
          echo "ğŸ§ª Testing basic gcloud auth..."
          if gcloud auth list --filter=status:ACTIVE --format="value(account)"; then
            echo "âœ… Successfully authenticated to GCP"
          else
            echo "âŒ GCP authentication failed"
            exit 1
          fi
          
          # Verify project access
          echo "ğŸ—ï¸ Testing project access..."
          PROJECT_ID=$(gcloud config get-value project)
          echo "ğŸ“‹ Current project: $PROJECT_ID"
          
          if [ "$PROJECT_ID" != "${{ secrets.GCP_PROJECT_ID }}" ]; then
            echo "âŒ Project mismatch! Expected: ${{ secrets.GCP_PROJECT_ID }}, Got: $PROJECT_ID"
            exit 1
          fi
          
          # Test service account details
          echo "ğŸ‘¤ Service account details:"
          gcloud auth list --filter=status:ACTIVE --format="table(account,status)"
          
          echo "=== ğŸ“¦ VALIDATING ARTIFACT REGISTRY ==="
          
          # Check if Artifact Registry API is enabled
          echo "ğŸ”Œ Checking Artifact Registry API..."
          if gcloud services list --enabled --filter="name:artifactregistry.googleapis.com" --format="value(name)"; then
            echo "âœ… Artifact Registry API is enabled"
          else
            echo "âŒ Artifact Registry API is not enabled"
            exit 1
          fi
          
          # Check if repository exists
          echo "ğŸ“¦ Checking api-images repository..."
          if gcloud artifacts repositories describe api-images --location=us-central1 --format="value(name)"; then
            echo "âœ… api-images repository exists"
          else
            echo "âŒ api-images repository does not exist"
            echo "ğŸ”§ Creating repository..."
            gcloud artifacts repositories create api-images \
              --repository-format=docker \
              --location=us-central1 \
              --description="API Docker images for production deployment"
          fi
          
          # Test Docker authentication
          echo "ğŸ³ Testing Docker authentication..."
          if gcloud auth configure-docker us-central1-docker.pkg.dev --quiet; then
            echo "âœ… Docker authentication configured"
          else
            echo "âŒ Docker authentication failed"
            exit 1
          fi
          
          # Test repository permissions
          echo "ğŸ”‘ Testing repository permissions..."
          SERVICE_NAME="api-csharp-main"
          IMAGE_NAME="us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/api-images/${SERVICE_NAME}:test"
          
          echo "ğŸ§ª Testing image push permissions with test image..."
          echo "FROM alpine:latest" > Dockerfile.test
          echo "RUN echo 'test'" >> Dockerfile.test
          
          if docker build -f Dockerfile.test -t ${IMAGE_NAME} . && docker push ${IMAGE_NAME}; then
            echo "âœ… Successfully pushed test image - permissions are correct!"
            # Clean up test image
            gcloud artifacts docker images delete ${IMAGE_NAME} --quiet || echo "âš ï¸ Could not delete test image (this is okay)"
          else
            echo "âŒ Failed to push test image - permission issue detected!"
            echo "ğŸ” Checking IAM permissions for service account..."
            
            # Get current service account
            CURRENT_SA=$(gcloud auth list --filter=status:ACTIVE --format="value(account)")
            echo "ğŸ“‹ Current service account: $CURRENT_SA"
            
            # Check IAM policy for the service account
            echo "ğŸ” IAM roles for service account:"
            gcloud projects get-iam-policy ${{ secrets.GCP_PROJECT_ID }} \
              --flatten="bindings[].members" \
              --format="table(bindings.role)" \
              --filter="bindings.members:$CURRENT_SA"
            
            exit 1
          fi
          
          # Clean up test files
          rm -f Dockerfile.test
          
          echo "=== âœ… ALL VALIDATIONS PASSED ==="

      - name: ğŸ³ Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker us-central1-docker.pkg.dev
      
      - name: ğŸ—ï¸ Build and Push Docker Image
        run: |
          # Use fixed service name for main deployment
          SERVICE_NAME="api-csharp-main"
          IMAGE_NAME="us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/api-images/${SERVICE_NAME}:${{ github.sha }}"
          
          echo "ğŸ·ï¸ Building image: $IMAGE_NAME"
          echo "ğŸ”– Service name: $SERVICE_NAME"
          
          # Build and push the image from repository root with correct context
          docker build -t $IMAGE_NAME -f apps/api/Dockerfile .
          docker push $IMAGE_NAME
          
          # Store values for next step
          echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV
          echo "SERVICE_NAME=$SERVICE_NAME" >> $GITHUB_ENV
      
      - name: ğŸš€ Deploy to Cloud Run
        id: deploy
        run: |
          # Validate GitHub token secret before deployment
          if [ -z "${{ secrets.GITHUB_TOKEN }}" ]; then
            echo "âŒ ERROR: GITHUB_TOKEN secret is not set!"
            echo "ğŸ” Please ensure the GITHUB_TOKEN secret is configured in repository settings"
            exit 1
          fi
          
          # Log token presence (first 4 characters for debugging)
          GITHUB_TOKEN_VALUE="${{ secrets.GITHUB_TOKEN }}"
          TOKEN_PREFIX=$(echo "$GITHUB_TOKEN_VALUE" | cut -c1-4)
          TOKEN_LENGTH=${#GITHUB_TOKEN_VALUE}
          echo "ğŸ”‘ GitHub Token Debug: prefix='$TOKEN_PREFIX' length=$TOKEN_LENGTH"
          
          # Deploy main production service
          echo "ğŸš€ Deploying main production service with name: $SERVICE_NAME"
          gcloud run deploy $SERVICE_NAME \
            --image $IMAGE_NAME \
            --platform managed \
            --region us-central1 \
            --allow-unauthenticated \
            --memory=512Mi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=10 \
            --timeout=60s \
            --concurrency=100 \
            --set-env-vars="ASPNETCORE_ENVIRONMENT=Production,GITHUB_TOKEN=$GITHUB_TOKEN_VALUE"
          
          # Get the service URL
          SERVICE_URL=$(gcloud run services describe $SERVICE_NAME --platform managed --region us-central1 --format 'value(status.url)')
          
          echo "ğŸŒ Main production service deployed at: $SERVICE_URL"
          echo "deployment_url=$SERVICE_URL" >> $GITHUB_OUTPUT
          
          # Verify environment variables were set correctly
          echo "ğŸ” Verifying environment variables in deployed service..."
          gcloud run services describe $SERVICE_NAME --platform managed --region us-central1 --format="value(spec.template.spec.template.spec.containers[0].env[].name,spec.template.spec.template.spec.containers[0].env[].value)"
        env:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      
      - name: âœ… Validate API Deployment
        run: |
          API_URL="${{ steps.deploy.outputs.deployment_url }}"
          echo "ğŸ” Testing main production API at: $API_URL"
          
          # Test health endpoint with retry and validate response
          for i in {1..5}; do
            echo "ğŸ¥ Health check attempt $i/5..."
            
            # Get health response
            HEALTH_RESPONSE=$(curl -s -f "$API_URL/health" -m 15)
            CURL_EXIT_CODE=$?
            
            if [ $CURL_EXIT_CODE -eq 0 ]; then
              echo "âœ… API responded successfully!"
              echo "ğŸ“„ Health Response: $HEALTH_RESPONSE"
              
              # Validate basic health response structure
              OVERALL_STATUS=$(echo "$HEALTH_RESPONSE" | jq -r '.status // "unknown"')
              
              echo "ğŸ” Overall Status: $OVERALL_STATUS"
              
              # Check if API is healthy
              if [ "$OVERALL_STATUS" = "healthy" ]; then
                echo "âœ… API is healthy and responding correctly!"
                break
              else
                echo "âŒ API is not reporting healthy status!"
                echo "ğŸ” Expected: status='healthy'"
                echo "ğŸ” Actual: status='$OVERALL_STATUS'"
                
                if [ $i -eq 5 ]; then
                  echo "âŒ Health check validation failed after 5 attempts"
                  exit 1
                fi
              fi
            else
              echo "âŒ API health endpoint failed (HTTP error)"
              
              if [ $i -eq 5 ]; then
                echo "âŒ API health check failed after 5 attempts"
                exit 1
              fi
            fi
            
            echo "â³ Waiting 10 seconds before retry..."
            sleep 10
          done
          
          # Test CORS by making a preflight request
          echo "ğŸŒ Testing CORS configuration..."
          CORS_RESPONSE=$(curl -s -X OPTIONS "$API_URL/health" \
            -H "Origin: https://odyssey-466315.web.app" \
            -H "Access-Control-Request-Method: GET" \
            -H "Access-Control-Request-Headers: Content-Type" \
            -w "%{http_code}" -o /dev/null)
          
          if [ "$CORS_RESPONSE" = "200" ]; then
            echo "âœ… CORS configuration is working correctly!"
          else
            echo "âš ï¸ CORS preflight returned status: $CORS_RESPONSE"
            echo "ğŸ” This may indicate CORS issues with the frontend"
          fi
      
      - name: ğŸ“Š Deployment Summary
        run: |
          echo "ğŸ¯ Main Production API Deployment Complete!"
          echo "ğŸ“ URL: ${{ steps.deploy.outputs.deployment_url }}"
          echo "ğŸ·ï¸ Service: $SERVICE_NAME"
          echo "âœ… Health check passed"