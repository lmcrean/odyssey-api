name: Main Branch Workflow

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  deployments: write
  checks: write

jobs:
  # Build and Deploy API
  build-api:
    uses: ./.github/workflows/templates/build.yml
    with:
      build_type: 'api'
      environment: 'production'
      run_tests: true

  deploy-api:
    needs: build-api
    uses: ./.github/workflows/templates/deploy.yml
    secrets: inherit
    with:
      deploy_type: 'api'
      environment: 'main'

  # Test API
  test-api:
    needs: deploy-api
    uses: ./.github/workflows/templates/test.yml
    with:
      test_type: 'api'
      api_url: ${{ needs.deploy-api.outputs.api_deployment_url }}
      environment: 'main'

  # Security validation for API
  security-api:
    needs: deploy-api
    uses: ./.github/workflows/templates/security.yml
    secrets: inherit
    with:
      check_type: 'gcp_validation'
      api_url: ${{ needs.deploy-api.outputs.api_deployment_url }}

  # Build and Deploy Web
  build-web:
    needs: [deploy-api, test-api]
    if: needs.test-api.result == 'success'
    uses: ./.github/workflows/templates/build.yml
    with:
      build_type: 'web'
      environment: 'production'
      api_url: ${{ needs.deploy-api.outputs.api_deployment_url }}
      run_tests: true

  deploy-web:
    needs: [build-web, deploy-api, test-api]
    if: needs.test-api.result == 'success'
    uses: ./.github/workflows/templates/deploy.yml
    secrets: inherit
    with:
      deploy_type: 'web'
      environment: 'main'
      api_url: ${{ needs.deploy-api.outputs.api_deployment_url }}

  # Integration Tests
  test-integration:
    needs: [deploy-api, test-api, deploy-web]
    uses: ./.github/workflows/templates/test.yml
    with:
      test_type: 'integration'
      web_url: ${{ needs.deploy-web.outputs.web_deployment_url }}
      api_url: ${{ needs.deploy-api.outputs.api_deployment_url }}
      environment: 'main'

  # E2E Tests
  test-e2e:
    needs: [deploy-api, test-api, deploy-web, test-integration]
    if: needs.test-integration.result == 'success'
    uses: ./.github/workflows/templates/test.yml
    with:
      test_type: 'e2e'
      web_url: ${{ needs.deploy-web.outputs.web_deployment_url }}
      api_url: ${{ needs.deploy-api.outputs.api_deployment_url }}
      environment: 'main'

  # Security validation for full deployment
  security-full:
    needs: [deploy-api, deploy-web]
    uses: ./.github/workflows/templates/security.yml
    secrets: inherit
    with:
      check_type: 'cors_test'
      api_url: ${{ needs.deploy-api.outputs.api_deployment_url }}
      web_url: ${{ needs.deploy-web.outputs.web_deployment_url }}

  # Release Summary
  deployment-summary:
    needs: [deploy-api, test-api, deploy-web, test-integration, test-e2e, security-api, security-full]
    if: always()
    uses: ./.github/workflows/templates/release.yml
    with:
      release_type: 'full_release'
      environment: 'main'
      api_url: ${{ needs.deploy-api.outputs.api_deployment_url }}
      web_url: ${{ needs.deploy-web.outputs.web_deployment_url }}
      api_deployment_status: ${{ needs.deploy-api.result }}
      web_deployment_status: ${{ needs.deploy-web.result }}
      api_test_status: ${{ needs.test-api.result }}
      integration_test_status: ${{ needs.test-integration.result }}
      e2e_test_status: ${{ needs.test-e2e.result }}